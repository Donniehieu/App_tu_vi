<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Xem Tử Vi Bắc Phái</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .laso-wrapper {
            width: 75vh;
            height: 100vh;
            max-width: 90vw;
            max-height: 90vw;
            aspect-ratio: 3/4;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }

        .laso-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            width: 100%;
            height: 100%;
            background: #fffbe7;
            border-radius: 12px;
            box-shadow: 0 2px 12px #0001;
            overflow: hidden;
            gap: 0;
        }

        .laso-cell {
            border: 1px solid #8d8d8d;
            display: flex;
            align-items: flex-start;
            justify-content: flex-start;
            padding: 6px;
            font-size: 0.97rem;
            min-width: 0;
            min-height: 0;
            background: #fffded;
            position: relative;
            box-sizing: border-box;
            transition: background 0.2s, border 0.2s;
        }

            .laso-cell.center {
                grid-column: 2 / span 2;
                grid-row: 2 / span 2;
                display: block;
                background: #f6fafd;
                font-weight: bold;
                font-size: 1rem;
                border: 1px solid #8d8d8d;
                z-index: 1;
                padding: 12px 4px;
                text-align: center;
            }

        .highlight-menh {
            background: #ffe566 !important;
            border: 2px solid #cc9900 !important;
        }

        .highlight-than {
            background: #c3e8ff !important;
            border: 2px solid #0070c0 !important;
        }
    </style>

    <script src="amlich-convert.js"></script>


</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="row justify-content-center" id="form-row">
            <div class="col-lg-6">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white text-center">
                        <h2 class="mb-0">Xem Tử Vi Bắc Phái</h2>
                    </div>
                    <div class="card-body">
                        <form id="form_tuvi">
                            <div class="mb-3">
                                <label for="hoten" class="form-label">Họ tên</label>
                                <input type="text" class="form-control" id="hoten" placeholder="Nhập họ tên">
                            </div>
                            <div class="row mb-3">
                                <div class="col">
                                    <label for="ngay" class="form-label">Ngày sinh</label>
                                    <input type="number" class="form-control" id="ngay" min="1" max="31" required>
                                </div>
                                <div class="col">
                                    <label for="thang" class="form-label">Tháng sinh</label>
                                    <input type="number" class="form-control" id="thang" min="1" max="12" required>
                                </div>
                                <div class="col">
                                    <label for="nam" class="form-label">Năm sinh</label>
                                    <input type="number" class="form-control" id="nam" min="1900" max="2100" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="gio" class="form-label">Giờ sinh</label>
                                <select class="form-select" id="gio">
                                    <option value="Tý">Tý (23h-1h)</option>
                                    <option value="Sửu">Sửu (1h-3h)</option>
                                    <option value="Dần">Dần (3h-5h)</option>
                                    <option value="Mão">Mão (5h-7h)</option>
                                    <option value="Thìn">Thìn (7h-9h)</option>
                                    <option value="Tỵ">Tỵ (9h-11h)</option>
                                    <option value="Ngọ">Ngọ (11h-13h)</option>
                                    <option value="Mùi">Mùi (13h-15h)</option>
                                    <option value="Thân">Thân (15h-17h)</option>
                                    <option value="Dậu">Dậu (17h-19h)</option>
                                    <option value="Tuất">Tuất (19h-21h)</option>
                                    <option value="Hợi">Hợi (21h-23h)</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="gioitinh" class="form-label">Giới tính</label>
                                <select class="form-select" id="gioitinh">
                                    <option value="Nam">Nam</option>
                                    <option value="Nữ">Nữ</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="namxemhan" class="form-label">Năm xem hạn</label>
                                <input type="number" class="form-control" id="namxemhan" min="1900" max="2100" required>
                            </div>
                            <div class="mb-3">
                                <button type="submit" id="btn_xemtuvi" class="btn btn-success w-100" disabled>Xem tử vi</button>
                            </div>
                        </form>
                        <div id="amlich" class="alert alert-info d-none"></div>
                        <div id="ketqua" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Lá số tử vi -->
        <div class="row justify-content-center d-none" id="laso-row">
            <div class="col-auto">
                <div class="laso-wrapper mt-5">
                    <div class="laso-grid" id="lasoGrid">
                        <!-- Hàng 1 -->
                        <div class="laso-cell cell1">Tỵ</div>
                        <div class="laso-cell cell2">Ngọ</div>
                        <div class="laso-cell cell3">Mùi</div>
                        <div class="laso-cell cell4">Thân</div>
                        <!-- Hàng 2 -->
                        <div class="laso-cell cell5">Thìn</div>
                        <div class="laso-cell center" id="cungGop">
                            <!-- JS sẽ điền thông tin -->
                        </div>
                        <div class="laso-cell cell8">Dậu</div>
                        <!-- Hàng 3 -->
                        <div class="laso-cell cell9">Mão</div>
                        <div class="laso-cell cell12">Tuất</div>
                        <!-- Hàng 4 -->
                        <div class="laso-cell cell13">Dần</div>
                        <div class="laso-cell cell14">Sửu</div>
                        <div class="laso-cell cell15">Tý</div>
                        <div class="laso-cell cell16">Hợi</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ThienCanNamSinh = "G.";
        let IDCungMenh = 0;
        let cucSo = 0;
       
        // Tên ác cung từ cung Mệnh thuận chiều kim đồng hồ
        const TEN_CUNG_FULL = [
            "Mệnh", "Phụ Mẫu", "Phúc Đức", "Điền Trạch",
            "Quan Lộc", "Nô Bộc", "Thiên Di", "Tật Ách",
            "Tài Bạch", "Tử Tức", "Phu Thê", "Huynh Đệ"
        ];
        // ------ Định nghĩa mệnh 60 hoa giáp ------
        const MENH_60HOAGIAP = [
            "Hải Trung Kim", "Hải Trung Kim", "Lư Trung Hỏa", "Lư Trung Hỏa", "Đại Lâm Mộc", "Đại Lâm Mộc",
            "Lộ Bàng Thổ", "Lộ Bàng Thổ", "Kiếm Phong Kim", "Kiếm Phong Kim", "Sơn Đầu Hỏa", "Sơn Đầu Hỏa",
            "Giản Hạ Thủy", "Giản Hạ Thủy", "Thành Đầu Thổ", "Thành Đầu Thổ", "Bạch Lạp Kim", "Bạch Lạp Kim",
            "Dương Liễu Mộc", "Dương Liễu Mộc", "Tuyền Trung Thủy", "Tuyền Trung Thủy", "Ốc Thượng Thổ", "Ốc Thượng Thổ",
            "Tích Lịch Hỏa", "Tích Lịch Hỏa", "Tùng Bách Mộc", "Tùng Bách Mộc", "Trường Lưu Thủy", "Trường Lưu Thủy",
            "Sa Trung Kim", "Sa Trung Kim", "Sơn Hạ Hỏa", "Sơn Hạ Hỏa", "Bình Địa Mộc", "Bình Địa Mộc",
            "Bích Thượng Thổ", "Bích Thượng Thổ", "Kim Bạch Kim", "Kim Bạch Kim", "Phúc Đăng Hỏa", "Phúc Đăng Hỏa",
            "Thiên Hà Thủy", "Thiên Hà Thủy", "Đại Dịch Thổ", "Đại Dịch Thổ", "Thoa Xuyến Kim", "Thoa Xuyến Kim",
            "Tang Đố Mộc", "Tang Đố Mộc", "Đại Khê Thủy", "Đại Khê Thủy", "Sa Trung Thổ", "Sa Trung Thổ",
            "Thiên Thượng Hỏa", "Thiên Thượng Hỏa", "Thạch Lựu Mộc", "Thạch Lựu Mộc", "Đại Hải Thủy", "Đại Hải Thủy"
        ];// Hàm lấy chỉ số 60 hoa giáp từ can chi (ĐÚNG QUY TẮC)
        function indexInSexagenary(can, chi) {
            const CAN = ["G.", "Ấ.", "B.", "Đ.", "M.", "K.", "C.", "T.", "N.", "Q."];
            const CHI = ["Tý", "Sửu", "Dần", "Mão", "Thìn", "Tỵ", "Ngọ", "Mùi", "Thân", "Dậu", "Tuất", "Hợi"];
            for (let i = 0; i < 60; ++i) {
                if (CAN[i % 10] === can && CHI[i % 12] === chi) return i;
            }
            return -1; // không tìm thấy
        }
        function traMenh(can, chi) {
            const idx = indexInSexagenary(can, chi);
            if (idx === -1) return "Không xác định";
            return MENH_60HOAGIAP[idx];
        }

        function tinhAmDuong(gioitinh, canNam) {
            const duong = ["G.", "B.", "M.", "C.", "N."];
            if (duong.includes(canNam)) {
                return gioitinh === "Nam" ? "Dương Nam" : "Dương Nữ";
            } else {
                return gioitinh === "Nam" ? "Âm Nam" : "Âm Nữ";
            }
        }

        function soCanNam(can) {
            if (["G.", "K."].includes(can)) return 1;
            if (["Ấ.", "C."].includes(can)) return 2;
            if (["B.", "T."].includes(can)) return 3;
            if (["Đ.", "N."].includes(can)) return 4;
            if (["M.", "Q."].includes(can)) return 5;
            return 0;
        }
        function soViTriMenh(chi) {
            if (["Tý", "Sửu"].includes(chi)) return 1;
            if (["Dần", "Mão", "Tuất", "Hợi"].includes(chi)) return 2;
            if (["Ngọ", "Mùi"].includes(chi)) return 3;
            if (["Tỵ", "Thìn"].includes(chi)) return 4;
            if (["Thân", "Dậu"].includes(chi)) return 5;
            return 0;
        }
        function traCuc(can, chi) {
            let s = soCanNam(can) + soViTriMenh(chi);
            if (s > 5) s -= 5;
            const arrCuc = ["", "Kim tứ cục", "Thủy nhị cục", "Hỏa lục cục", "Thổ ngũ cục", "Mộc tam cục"];
            return arrCuc[s];
        }

        function tinhcucSo(tenCuc) {

            if (tenCuc == "Thủy nhị cục") return 2;
            if (tenCuc == "Mộc tam cục") return 3;
            if (tenCuc == "Kim tứ cục") return 4;
            if (tenCuc == "Thổ ngũ cục") return 5;
            if (tenCuc == "Hỏa lục cục") return 6;

            
        }
        // Mapping chuẩn 12 cung ngoài Bắc phái (theo cell HTML và chi)
        const CUNG_CELLS = [
            { cell: 13, chi: "Dần" },
            { cell: 9, chi: "Mão" },
            { cell: 5, chi: "Thìn" },
            { cell: 1, chi: "Tỵ" },
            { cell: 2, chi: "Ngọ" },
            { cell: 3, chi: "Mùi" },
            { cell: 4, chi: "Thân" },
            { cell: 8, chi: "Dậu" },
            { cell: 12, chi: "Tuất" },
            { cell: 16, chi: "Hợi" },
            { cell: 15, chi: "Tý" },
            { cell: 14, chi: "Sửu" }
        ];

                const TEN_SAO_CHINH_THEO_TUVI = {
            tuVi: "Tử Vi",
            thienCo: "Thiên Cơ",
            thaiDuong: "Thái Dương",
            vuKhuc: "Vũ Khúc",
            thienDong: "Thiên Đồng",
            liemTrinh: "Liêm Trinh"
        };

        // Chi 12 con giáp thứ tự
        const CHI12 = ["Tý", "Sửu", "Dần", "Mão", "Thìn", "Tỵ", "Ngọ", "Mùi", "Thân", "Dậu", "Tuất", "Hợi"];

        // Hàm xác định cell cung mệnh (chuẩn Bắc phái)
        function getMenhCell(thang_am, gio_chi) {
            let thangIdx = (thang_am - 1) % 12; // Tháng Giêng index 0 (Dần)
            let gioIdx = CHI12.indexOf(gio_chi); // Tỵ = 5
            let menhIdx = (thangIdx - gioIdx + 12) % 12;
            IDCungMenh = menhIdx;
            let obj = CUNG_CELLS[menhIdx];
            hienThiTenCungLaso(menhIdx); // Hiển thị tên cung trên bàn lá số
            return obj; // {cell: xx, chi: "..."}
        }

        // Highlight cung mệnh trên bàn tử vi
        function highlightMenhCell(cellNum) {
            document.querySelectorAll('.laso-cell').forEach(e => e.classList.remove('highlight-menh'));
            let cell = document.querySelector('.cell' + cellNum);
            if (cell) cell.classList.add('highlight-menh');
        }

        // Kiểm tra hợp lệ ngày/tháng/năm dương lịch và cảnh báo
        function isLeapYear(year) {
            year = parseInt(year);
            return (year % 400 === 0) || (year % 4 === 0 && year % 100 !== 0);
        }

        function getMaxDay(month, year) {
            month = parseInt(month);
            year = parseInt(year);
            if ([1, 3, 5, 7, 8, 10, 12].includes(month)) return 31;
            if ([4, 6, 9, 11].includes(month)) return 30;
            if (month === 2) {
                return isLeapYear(year) ? 29 : 28;
            }
            return 31; // fallback
        }

        // hàm tính lùi cung
            function luiCung(idx, soCung) {
        // idx: vị trí hiện tại (1-12), soCung: số cung lùi
        return ((idx - soCung - 1 + 12) % 12) + 1;
}

        // Tính vị trí các sao chính tinh dựa vào vị trí Tử Vi
        function getChinhTinhFromTuVi(idxTuVi) {
            // idxTuVi: 1-12
            // lùi cung (ngược kim đồng hồ): ((idxTuVi - soCung - 1 + 12) % 12) + 1
            function luiCung(idx, soCung) {
                return ((idx - soCung - 1 + 12) % 12) + 1;
            }
            return {
                tuVi: idxTuVi,
                thienCo: luiCung(idxTuVi, 1),
                thaiDuong: luiCung(idxTuVi, 3),
                vuKhuc: luiCung(idxTuVi, 4),
                thienDong: luiCung(idxTuVi, 5),
                liemTrinh: luiCung(idxTuVi, 8),
            };
        }

       function displayChinhTinhOnLaSo(idxTuVi) {
    // Lấy vị trí từng sao
    const pos = getChinhTinhFromTuVi(idxTuVi); // {tuVi:..., thienCo:..., ...}
    // Tạo map cung - danh sách sao
    const saoTrenCung = {};
    for (let i = 1; i <= 12; ++i) saoTrenCung[i] = [];
    for (const [k, v] of Object.entries(pos)) {
        saoTrenCung[v].push(TEN_SAO_CHINH_THEO_TUVI[k]);
    }
    // Hiển thị lên từng cell trong bàn lá số (theo CUNG_CELLS)
    for (let i = 0; i < 12; ++i) {
        const cellNum = CUNG_CELLS[i].cell;
        const cell = document.querySelector('.cell' + cellNum);
        if (cell) {
            // Xoá sao cũ nếu có
            let old = cell.querySelector('.chinh-tinh-label');
            if (old) old.remove();
            // Thêm tên các sao chính tinh (nếu có)
            if (saoTrenCung[i+1].length > 0) {
                cell.insertAdjacentHTML('beforeend',
                    `<div class="chinh-tinh-label" style="position:absolute;left:0;right:0;top:28px;text-align:center;font-weight:bold;color:#be0e8c;font-size:1em;z-index:2;">
                        ${saoTrenCung[i+1].join(', ')}
                    </div>`);
            }
        }
    }
}

        // Hàm điền tên cung vào bàn lá số theo vị trí
       function hienThiTenCungLaso(menhIdx, highlightTuViIdx = null) {
        for (let i = 0; i < 12; ++i) {
            let cc = CUNG_CELLS[(menhIdx + i) % 12];
            let tenCung = TEN_CUNG_FULL[i];
            let cell = document.querySelector('.cell' + cc.cell);
            if (cell) {
                // Xóa nội dung cũ, thêm tên cung ở top center
                cell.innerHTML = `
                    <div style="font-weight:bold;text-align:center;width:100%;position:absolute;top:2px;left:0;right:0;font-size:1.05em;color:#a66300;">
                        ${tenCung}
                    </div>
                    <div style="top:2px; font-size:12px;text-align:left;width:100%">
                        ${getCanThang12Cung(ThienCanNamSinh)[(menhIdx + i) % 12]}  ${cc.chi}
                    </div>
                    <div style="font-weight:bold;text-align:center;width:100%;position:absolute;left:0;right:0;top:20px;font-size:1.04em;color:#7b1fa2;">
                        ${(highlightTuViIdx !== null && ((menhIdx + i) % 12 + 1) === highlightTuViIdx) ? 'Tử Vi' : ''}
                    </div>
                `;
            }
        }
    }





        const ngayInput = document.getElementById('ngay');
        const thangInput = document.getElementById('thang');
        const namInput = document.getElementById('nam');
        const btnTuvi = document.getElementById('btn_xemtuvi');
        const amlichDiv = document.getElementById('amlich');

        function validateDateInput() {
            const day = parseInt(ngayInput.value);
            const month = parseInt(thangInput.value);
            const year = parseInt(namInput.value);

            if (!month || !year) {
                amlichDiv.classList.add('d-none');
                btnTuvi.disabled = true;
                return;
            }
            const maxDay = getMaxDay(month, year);
            ngayInput.max = maxDay; // cập nhật max cho input ngày

            if (day > maxDay) {
                amlichDiv.classList.remove('d-none');
                amlichDiv.classList.add('alert-danger');
                amlichDiv.classList.remove('alert-info');
                amlichDiv.innerText = `Tháng ${month} năm ${year} chỉ có tối đa ${maxDay} ngày. Vui lòng nhập lại ngày!`;
                btnTuvi.disabled = true;
            } else {
                // Kiểm tra các trường khác đã đủ chưa để enable nút
                const hoten = document.getElementById('hoten').value.trim();
                const namxemhan = document.getElementById('namxemhan').value;
                if (hoten && day && month && year && namxemhan) {
                    btnTuvi.disabled = false;
                } else {
                    btnTuvi.disabled = true;
                }
                // Ẩn cảnh báo nếu trước đó có lỗi
                if (amlichDiv.innerText.includes('chỉ có tối đa')) {
                    amlichDiv.classList.add('d-none');
                    amlichDiv.classList.remove('alert-danger');
                    amlichDiv.classList.add('alert-info');
                    amlichDiv.innerText = '';
                }
            }
        }
        // Hàm xác định cell cung thân (theo Bắc phái)
        function getThanCell(thang_am, gio_chi) {
            let thangIdx = (thang_am - 1) % 12;
            let gioIdx = CHI12.indexOf(gio_chi);
            let thanIdx = (thangIdx + gioIdx) % 12;
            let obj = CUNG_CELLS[thanIdx];
            return obj;
        }
        function highlightThanCell(cellNum) {
            document.querySelectorAll('.laso-cell').forEach(e => e.classList.remove('highlight-than'));
            let cell = document.querySelector('.cell' + cellNum);
            if (cell) cell.classList.add('highlight-than');
        }

        // hàm check khi input ngày tháng năm
        ngayInput.addEventListener('input', validateDateInput);
        thangInput.addEventListener('input', validateDateInput);
        namInput.addEventListener('input', validateDateInput);

        document.getElementById('form_tuvi').addEventListener('input', function () {
            const hoten = document.getElementById('hoten').value.trim();
            const ngay = document.getElementById('ngay').value;
            const thang = document.getElementById('thang').value;
            const nam = document.getElementById('nam').value;
            const namxemhan = document.getElementById('namxemhan').value;
            // Chỉ enable nếu hợp lệ ngày tháng năm (được validate ở trên)
            validateDateInput();
        });

        const START_CAN_THANG_TU_DAN = {
            "G.": 2, "K.": 2,   // Bính Dần
            "Ấ.": 4, "C.": 4,   // Mậu Dần
            "B.": 6, "T.": 6,  // Canh Dần
            "Đ.": 8, "N.": 8, // Nhâm Dần
            "M.": 0, "Q.": 0    // Giáp Dần
        };
        // Hàm lấy 12 thiên can cho 12 cung bắt đầu từ Dần (cung 13) theo can năm sinh âm lịch
        function getCanThang12Cung(canNam) {
            const startCan = START_CAN_THANG_TU_DAN[canNam];
            let canArr = [];
            for (let i = 0; i < 12; ++i) {
                canArr.push(CAN[(startCan + i) % 10]);
            }

            return canArr;
        }

        // Khi hiển thị lên bàn lá số và bảng, dùng như sau:
        function render12CungCanChi(menhChi, canNam) {
            // CUNG_CELLS: [{cell, chi}] bắt đầu từ Dần thuận kim đồng hồ
            let menhIdx = CUNG_CELLS.findIndex(c => c.chi === menhChi);
            let can12 = getCanThang12Cung(canNam);
            let html = "<table class='table table-sm table-bordered mt-2'><thead><tr><th>#</th><th>Cung</th><th>Can Chi</th></tr></thead><tbody>";
            for (let i = 0; i < 12; ++i) {
                let cc = CUNG_CELLS[(menhIdx + i) % 12];
                let tenCung = TEN_CUNG_FULL[i];
                let can = can12[i];
                html += `<tr${i === 0 ? ' style="font-weight:bold;background:#ffe"' : ''}><td>${i + 1}</td><td>${tenCung}</td><td>${can} ${cc.chi}</td></tr>`;
            }
            html += "</tbody></table>";

            return html;


        }
       
                /**
        * Tính đại vận cho 12 cung lá số tử vi Bắc phái.
        * @param {number} menhIdx - Chỉ số cung Mệnh (0-11, bắt đầu từ Dần thuận chiều kim đồng hồ)
        * @param {number} cucSo - Số của Cục (2~6)
        * @param {string} amduong - Chuỗi: "Dương Nam", "Dương Nữ", "Âm Nam", "Âm Nữ"
        * @returns {Array<number>} - Mảng 12 số đại vận ứng với 12 cung, index 0 là cung Mệnh, tiếp đến các cung xung quanh.
        */
                function tinhdaivan(menhIdx, cucSo, amduong) {
                    // Số đại vận cho 12 cung, khởi tạo
                    let daiVanArr = Array(12).fill(0);
                    // Xác định chiều: thuận = +1, ngược = -1
                    let isThuan = (amduong === "Dương Nam" || amduong === "Âm Nữ");
                    // Đặt số cục tại cung Mệnh
                    let idx = menhIdx;
                    for (let i = 0; i < 12; ++i) {
                        daiVanArr[idx] = cucSo + i * 10;
                        // Tính chỉ số cung tiếp theo
                        idx = (idx + (isThuan ? 1 : -1) + 12) % 12;
                    }
                    return daiVanArr;
                }


                    /**
            * Tính mảng 12 năm tiểu vận ứng với 12 cung lá số tử vi Bắc phái.
            * @param {string} chiNamSinh - Chi năm sinh (ví dụ: "Tý", "Sửu", "Dần"...)
            * @param {number} tuoiAm - Tuổi âm lịch người xem hạn (năm xem hạn - năm âm lịch sinh + 1)
            * @param {string} gioitinh - "Nam"/"Nữ"
            * @returns {Array<string>} - Mảng 12 chi ứng với tiểu vận cho 12 cung, index 0 là cung khởi, thuận/ nghịch theo giới tính.
            */
                    function tinhTieuvan(chiNamSinh, chiNam, gioitinh) {
                        // Xác định cung khởi tiểu vận dựa vào chi năm sinh
                        // Dần Ngọ Tuất -> Thìn, Thân Tý Thìn -> Tuất, Tỵ Dậu Sửu -> Mùi, Hợi Mão Mùi -> Sửu
                        const CHI12 = ["Tý", "Sửu", "Dần", "Mão", "Thìn", "Tỵ", "Ngọ", "Mùi", "Thân", "Dậu", "Tuất", "Hợi"];
                        const tieuvanKhoi = (() => {
                            if (["Dần", "Ngọ", "Tuất"].includes(chiNamSinh)) return "Thìn";
                            if (["Thân", "Tý", "Thìn"].includes(chiNamSinh)) return "Tuất";
                            if (["Tỵ", "Dậu", "Sửu"].includes(chiNamSinh)) return "Mùi";
                            if (["Hợi", "Mão", "Mùi"].includes(chiNamSinh)) return "Sửu";
                            // fallback: default về Tý nếu không xác định được
                            return "Tý";
                        })();
                        // Tìm vị trí cung khởi trong CUNG_CELLS
                        const khoiIdx = CUNG_CELLS.findIndex(c => c.chi === tieuvanKhoi);
                        if (khoiIdx === -1) return Array(12).fill("");
                        // Xác định chiều: Nam thuận, Nữ nghịch (thứ tự điền cung)
                        const step = gioitinh === "Nam" ? 1 : -1;

                        // Tính chi của năm tiểu hạn đầu tiên (năm tuổi âm)
                        let chiIdx = CHI12.indexOf(chiNamSinh);
                        let tieuvanArr = Array(12).fill("");
                        for (let i = 0; i < 12; ++i) {
                            // Vị trí cung hiện tại
                            let cungIdx = (khoiIdx + i * step + 12 * 5) % 12;
                            // Chi năm tiểu hạn tương ứng
                            let chi = CHI12[(chiIdx + i) % 12];
                            
                            if (chi== chiNam) {
                                tieuvanArr[cungIdx] = chi + " (T.H)";
                            } else {
                                tieuvanArr[cungIdx] = chi;
                            }
                        }
                        return tieuvanArr;
                    }


                                /**
             * An sao Tử Vi - đánh số cung Dần = 1, Mão = 2, ..., Sửu = 12
             * @param {number} ngay_am - Ngày sinh âm lịch (1-30)
             * @param {number} cucSo - Số của cục (2,3,4,5,6)
             * @returns {number} - Index cung (1-12, Dần = 1, ..., Sửu = 12)
             */
            function anSaoTuVi(ngay_am, cucSo) {
                let quotient = Math.floor(ngay_am / cucSo);
                let remainder = ngay_am % cucSo;
                let startIdx = 1; // Dần = 1

                if (remainder === 0) {
                    // Chia hết: từ Dần tiến thuận số bước = thương, Dần là 1
                    let viTri = ((startIdx + quotient - 1) % 12);
                    return viTri === 0 ? 12 : viTri;
                } else {
                    let soMuon = cucSo - remainder;
                    let ngayMuon = ngay_am + soMuon;
                    let chiaHetIdx = ((startIdx + Math.floor(ngayMuon / cucSo) - 1) % 12);
                    chiaHetIdx = chiaHetIdx === 0 ? 12 : chiaHetIdx;
                    if (soMuon % 2 === 0) {
                        // Số mượn chẵn: tiến thuận số bước = số mượn
                        let viTri = ((chiaHetIdx + soMuon - 1) % 12) + 1;
                        return viTri > 12 ? viTri - 12 : viTri;
                    } else {
                        // Số mượn lẻ: lùi nghịch số bước = số mượn
                        let viTri = ((chiaHetIdx - soMuon - 1 + 12 * 2) % 12) + 1;
                        return viTri > 12 ? viTri - 12 : viTri;
                    }
                }
            }
            // hàm xác định vị trí Thiên Phủ đối xứng Dần Thân với Tử Vi

                   const tuViThienPhuPairs = [
            ["Dần", "Dần"],
            ["Mão", "Sửu"],
            ["Thìn", "Tý"],
            ["Tỵ", "Hợi"],
            ["Ngọ", "Tuất"],
            ["Mùi", "Dậu"],
            ["Thân", "Thân"],
            ["Dậu", "Mùi"],
            ["Tuất", "Ngọ"],
            ["Hợi", "Tỵ"],
            ["Tý", "Thìn"],
            ["Sửu", "Mão"],
        ];

        // cho idxTuVi là vị trí cung 1-12 (Dần=1,...,Sửu=12), tìm ra vị trí thiên phủ (1-12)
        function viTriThienPhu(idxTuVi) {
            // CUNG_CELLS thứ tự Dần(1), Mão(2), ..., Sửu(12)
            const chiTuVi = CUNG_CELLS[idxTuVi - 1].chi;
            // Tìm cặp ứng chi
            for (const [chiTV, chiTP] of tuViThienPhuPairs) {
                if (chiTV === chiTuVi) {
                    // Tìm idx Thiên Phủ
                    return CUNG_CELLS.findIndex(c => c.chi === chiTP) + 1; // trả về 1-12
                }
            }
            // fallback
            return idxTuVi;
        }

            // hàm An các sao theo sao Thiên Phủ
            function cacSaoTuThienPhu(idxThienPhu) {
            function tienCung(idx, soCung) {
                // idx: vị trí hiện tại (1-12)
                return ((idx + soCung - 1) % 12) + 1;
            }
            return {
                thienPhu: idxThienPhu,
                thaiAm: tienCung(idxThienPhu, 1),
                thamLang: tienCung(idxThienPhu, 2),
                cuMon: tienCung(idxThienPhu, 3),
                thienTuong: tienCung(idxThienPhu, 4),
                thienLuong: tienCung(idxThienPhu, 5),
                thatSat: tienCung(idxThienPhu, 6),
                phaQuan: tienCung(idxThienPhu, 10),
            };
        }

        // hàm thực hiện khi bấm nút
        document.getElementById('form_tuvi').addEventListener('submit', function (e) {
            e.preventDefault();
            const hoten = document.getElementById('hoten').value.trim();
            const ngay = parseInt(document.getElementById('ngay').value);
            const thang = parseInt(document.getElementById('thang').value);
            const nam = parseInt(document.getElementById('nam').value);
            const gio = document.getElementById('gio').value;
            const gioitinh = document.getElementById('gioitinh').value;
            const namxemhan = parseInt(document.getElementById('namxemhan').value);

            if (typeof getCanChiFull !== "function") {
                document.getElementById('cungGop').innerHTML = '<div class="text-danger">Không tìm thấy thư viện amlich-convert.js. Vui lòng kiểm tra lại đường dẫn và tải trang.</div>';
                document.getElementById('laso-row').classList.remove('d-none');
                return;
            }
            const kq = getCanChiFull(ngay, thang, nam, gio.split(' ')[0]);
            const am = kq.amlich;
            const canchi = kq.canchi;

            // Năm xem hạn (dương lịch)
            const CAN = ["G.", "Ấ.", "B.", "Đ.", "M.", "K.", "C.", "T.", "N.", "Q."];
            const CHI = ["Tý", "Sửu", "Dần", "Mão", "Thìn", "Tỵ", "Ngọ", "Mùi", "Thân", "Dậu", "Tuất", "Hợi"];
            const canchiNamXemHan = CAN[(namxemhan - 4) % 10] + " " + CHI[(namxemhan - 4) % 12];
            const tuoiAm = namxemhan - am.nam + 1;
            const chiNamXemhan = CHI[(namxemhan - 4) % 12];

            // --- TÍCH HỢP ÂM DƯƠNG, MỆNH, CỤC ---
            const canNam = canchi.nam.split(' ')[0];
            const chiNam = canchi.nam.split(' ')[1];
            const amduong = tinhAmDuong(gioitinh, canNam);
            const menh = traMenh(canNam, chiNam);
            ThienCanNamSinh = canNam;
            // Xác định vị trí cung Mệnh
            const menhObj = getMenhCell(am.thang, gio.split(' ')[0]);
            const chiMenh = menhObj.chi;
            const cellMenh = menhObj.cell;


            // Xác định cung thân
            const thanObj = getThanCell(am.thang, gio.split(' ')[0]);
            const chiThan = thanObj.chi;
            const cellThan = thanObj.cell;
            document.getElementById('cungGop').innerHTML += `<div><b>Cung Thân:</b> ${chiThan}</div>`;
      

            // Tính Cục
            const cuc = traCuc(canNam, chiMenh);
            // An đại vận
            cucSo = tinhcucSo(cuc);

            // An Sao tử vi

            const idxTuVi = anSaoTuVi(am.ngay, cucSo);

            displayChinhTinhOnLaSo(idxTuVi);

            // 1. Xác định vị trí Thiên Phủ
            const idxThienPhu = viTriThienPhu(idxTuVi);

            // 2. An các sao từ Thiên Phủ
            const saoTuThienPhu = cacSaoTuThienPhu(idxThienPhu);

            // 3. Gộp dữ liệu các sao lại với từng cung
            const tenSaoTP = {
                thienPhu: "Thiên Phủ",
                thaiAm: "Thái Âm",
                thamLang: "Tham Lang",
                cuMon: "Cự Môn",
                thienTuong: "Thiên Tướng",
                thienLuong: "Thiên Lương",
                thatSat: "Thất Sát",
                phaQuan: "Phá Quân"
            };
            const saoTrenCungTP = {};
            for (let i = 1; i <= 12; ++i) saoTrenCungTP[i] = [];
            for (const [k, v] of Object.entries(saoTuThienPhu)) {
                saoTrenCungTP[v].push(tenSaoTP[k]);
            }

            // Hiển thị lên từng cell
            for (let i = 0; i < 12; ++i) {
                const cellNum = CUNG_CELLS[i].cell;
                const cell = document.querySelector('.cell' + cellNum);
                if (cell) {
                    // Xoá sao cũ nếu có
                    let old = cell.querySelector('.phu-tinh-label');
                    if (old) old.remove();
                    // Thêm tên các sao phụ tinh (nếu có)
                    if (saoTrenCungTP[i+1].length > 0) {
                        cell.insertAdjacentHTML('beforeend',
                            `<div class="phu-tinh-label" style="position:absolute;left:0;right:0;top:45px;text-align:center;font-weight:bold;color:#1e88e5;font-size:0.95em;z-index:2;">
                                ${saoTrenCungTP[i+1].join(', ')}
                            </div>`);
                    }
                }
            }
          
            
            const lsDaiVan = tinhdaivan(IDCungMenh, cucSo, amduong);
          
            // Xóa thông tin đại vận cũ nếu có
            document.querySelectorAll('.laso-cell').forEach(cell => {
                let old = cell.querySelector('.daivan-label');
                if (old) old.remove();
            });
            // Hiển thị đại vận trên 12 cung
            for (let i = 0; i < 12; ++i) {
                let cellNum = CUNG_CELLS[i].cell;
                let cell = document.querySelector('.cell' + cellNum);
                if (cell) {
                    cell.insertAdjacentHTML('afterbegin',
                        `<div class="daivan-label" style="position:absolute; top:2px; right:4px; color:#0070c0; font-size:0.98em; font-weight:bold; z-index:2;">
                ${lsDaiVan[i]}
            </div>`);
                }
            }

        
            // Ví dụ sử dụng sau khi xác định chiNam, tuoiAm, gioitinh
            const arrTieuvan = tinhTieuvan(chiNam, chiNamXemhan, gioitinh);

            // khi render: với mỗi cell ứng với CUNG_CELLS[i], chèn arrTieuvan[i] ở góc trái dưới cùng
            for (let i = 0; i < 12; ++i) {
                let cellNum = CUNG_CELLS[i].cell;
                let cell = document.querySelector('.cell' + cellNum);
                if (cell) {
                    cell.insertAdjacentHTML('beforeend',
                        `<div class="tieuvan-label" style="position:absolute; left:2px; bottom:2px; color:#e67e22; font-size:0.98em; font-weight:bold; z-index:2;">
                ${arrTieuvan[i]}
            </div>`);
                }
            }

            // === AN SAO CỐ ĐỊNH: Thiên La – Địa Võng, Thiên Thương – Thiên Sứ ===
    const SAO_CODINH = [
        { ten: "Thiên La", chi: "Thìn", loai: "xau" },
        { ten: "Địa Võng", chi: "Tuất", loai: "xau" },
        { ten: "Thiên Thương", cung: "Nô Bộc", loai: "xau" },
        { ten: "Thiên Sứ", cung: "Tật Ách", loai: "xau" }
    ];
    // Map tên cung sang index (bắt đầu từ cung Mệnh, thuận chiều kim đồng hồ)
    const TEN_CUNG_MAP = {
        "Mệnh": 0, "Phụ Mẫu": 1, "Phúc Đức": 2, "Điền Trạch": 3,
        "Quan Lộc": 4, "Nô Bộc": 5, "Thiên Di": 6, "Tật Ách": 7,
        "Tài Bạch": 8, "Tử Tức": 9, "Phu Thê": 10, "Huynh Đệ": 11
    };
    // Hiển thị sao cố định lên bàn lá số
    function hienThiSaoCoDinh(menhIdx) {
        // Xóa nhãn cũ
        document.querySelectorAll('.laso-cell').forEach(cell => {
            let old = cell.querySelector('.sao-codinh-label');
            if (old) old.remove();
        });
        // B1: An Thiên La, Địa Võng theo chi
        SAO_CODINH.forEach(sao => {
            let cellNum = null;
            if (sao.chi) {
                // Tìm cell theo chi
                let found = CUNG_CELLS.find(c => c.chi === sao.chi);
                if (found) cellNum = found.cell;
            } else if (sao.cung) {
                // Tìm cell theo tên cung (tính từ cung Mệnh)
                let cungIdx = (menhIdx + TEN_CUNG_MAP[sao.cung]) % 12;
                cellNum = CUNG_CELLS[cungIdx].cell;
            }
            if (cellNum) {
                let cell = document.querySelector('.cell' + cellNum);
                if (cell) {
                    cell.insertAdjacentHTML('beforeend', 
                        `<div class="sao-codinh-label" style="position:absolute;right:2px;top:65px;color:#d84315;font-weight:bold;font-size:0.95em;z-index:3;">
                            ${sao.ten}
                        </div>`);
                }
            }
        });
    }
   
            hienThiSaoCoDinh(IDCungMenh);
            // ======== An các sao theo tháng sinh ========

            // Quy tắc mapping: {ten: ..., startChi: ..., startCell: ..., direction: 1/-1}
            const SAO_THANGSINH = [
                { ten: 'Thiên Hình', startChi: 'Dậu', direction: 1 }, // Dậu là tháng 1, thuận
                { ten: 'Thiên Y', startChi: 'Sửu', direction: 1 },    // Sửu là tháng 1, thuận
                { ten: 'Thiên Riêu', startChi: 'Sửu', direction: 1 }, // Sửu là tháng 1, thuận
                { ten: 'Thiên Giải', startChi: 'Thân', direction: 1 },// Thân là tháng 1, thuận
                { ten: 'Địa Giải', startChi: 'Mùi', direction: 1 },   // Mùi là tháng 1, thuận
                { ten: 'Tả Phụ', startChi: 'Thìn', direction: 1 },    // Thìn là tháng 1, thuận
                { ten: 'Hữu Bật', startChi: 'Tuất', direction: -1 },  // Tuất là tháng 1, NGƯỢC
            ];
            let idx_taPhu = null, idx_huuBat = null;
            function anSaoTheoThangSinh(thang_am, menhIdx) {
                // Xóa nhãn cũ nếu có
                document.querySelectorAll('.laso-cell').forEach(cell => {
                    let olds = cell.querySelectorAll('.phutinhthem-label');
                    olds.forEach(o => o.remove());
                });
               
                SAO_THANGSINH.forEach(sao => {
                    // Tìm vị trí xuất phát (startIdx) trong CUNG_CELLS
                    let startIdx = CUNG_CELLS.findIndex(c => c.chi === sao.startChi);
                    if (startIdx === -1) return;
                    // Tính vị trí cung sẽ an sao (thang_am: 1~12)
                    // Do CUNG_CELLS bắt đầu từ Dần (index 0), startIdx là index trong CUNG_CELLS
                    // Mỗi bước là 1 tháng, tháng 1 là vị trí xuất phát
                    let idx;
                    if (sao.direction === 1) {
                        idx = (startIdx + (thang_am - 1)) % 12;
                    } else {
                        idx = (startIdx - (thang_am - 1) + 12 * 3) % 12;
                    }
                    let cellNum = CUNG_CELLS[idx].cell;
                    // Ghi nhận vị trí Tả Phụ/Hữu Bật
                    if (sao.ten === "Tả Phụ") idx_taPhu = idx;
                    if (sao.ten === "Hữu Bật") idx_huuBat = idx;
                    let cell = document.querySelector('.cell' + cellNum);
                    if (cell) {
                        // Hiển thị bên phải (sao xấu) hoặc trái (sao tốt), tạm để bên phải cho đồng nhất
                        cell.insertAdjacentHTML('beforeend',
                            `<div class="phutinhthem-label" style="position:absolute; right:2px; top:38px; color:#a83232; font-size:0.93em; font-weight:bold; z-index:3;">
                    ${sao.ten}
                </div>`);
                    }
                   
                });
                // trả về vị trí tả phụ, hữu bật
                return { taPhuIdx: idx_taPhu, huuBatIdx: idx_huuBat };
            }
            const thangSinhSaoIdx = anSaoTheoThangSinh(am.thang, IDCungMenh);

            // ------- GỌI TRONG HÀM SUBMIT, sau khi đã xác định am.thang và IDCungMenh --------
            // Ngay sau khi highlightMenhCell(cellMenh); ... và highlightThanCell(cellThan);
            // Thêm dòng này:
          
           
            // Các sao an theo giờ sinh
            const SAO_GIO_SINH = [
                { ten: "Văn Xương", startChi: "Tuất", direction: -1, className: "sao-gio-vanxuong", color: "#8e24aa" },
                { ten: "Văn Khúc", startChi: "Thìn", direction: 1, className: "sao-gio-vankhuc", color: "#3949ab" },
                { ten: "Thai Phụ", startChi: "Ngọ", direction: 1, className: "sao-gio-thaiphu", color: "#2e7d32" },
                { ten: "Phong Cáo", startChi: "Dần", direction: 1, className: "sao-gio-phongcao", color: "#d84315" },
                { ten: "Địa Kiếp", startChi: "Hợi", direction: 1, className: "sao-gio-diakiep", color: "#b71c1c" },
                { ten: "Địa Không", startChi: "Hợi", direction: -1, className: "sao-gio-diakhong", color: "#546e7a" },
            ];
           
            /**
             * An các sao phụ tinh theo giờ sinh lên từng cung
             * @param {string} gio_sinh_chi - giờ sinh ("Tý",..., "Hợi")
             */
            let idx_vanXuong = null, idx_vanKhuc = null;
            function anSaoTheoGioSinh(gio_sinh_chi) {
                // Thứ tự 12 chi giờ
                const GIO12 = ["Tý", "Sửu", "Dần", "Mão", "Thìn", "Tỵ", "Ngọ", "Mùi", "Thân", "Dậu", "Tuất", "Hợi"];
                // Xóa nhãn cũ
                document.querySelectorAll('.laso-cell').forEach(cell => {
                    cell.querySelectorAll('.sao-gio-vanxuong, .sao-gio-vankhuc, .sao-gio-thaiphu, .sao-gio-phongcao, .sao-gio-diakiep, .sao-gio-diakhong')
                        .forEach(e => e.remove());
                });
                SAO_GIO_SINH.forEach(sao => {
                    let startIdx = CUNG_CELLS.findIndex(c => c.chi === sao.startChi);
                    if (startIdx === -1) return;
                    let gioIdx = GIO12.indexOf(gio_sinh_chi);
                    if (gioIdx === -1) return;
                    // direction: 1 (thuận), -1 (ngược), giờ Tý là startIdx
                    let idx;
                    if (sao.direction === 1) {
                        idx = (startIdx + gioIdx) % 12;
                    } else {
                        idx = (startIdx - gioIdx + 12 * 3) % 12;
                    }
                    if (sao.ten === "Văn Xương") idx_vanXuong = idx;
                    if (sao.ten === "Văn Khúc") idx_vanKhuc = idx;
                    let cellNum = CUNG_CELLS[idx].cell;
                   
                    let cell = document.querySelector('.cell' + cellNum);
                    if (cell) {
                        // Đếm số nhãn đã có để lùi vị trí cho không bị trùng
                        let count = cell.querySelectorAll('.' + sao.className).length;
                        let baseTop = 110; // px, chỉnh phù hợp với các nhãn khác nếu muốn
                        let offset = 18;  // px
                        let top = baseTop + count * offset;
                        cell.insertAdjacentHTML('beforeend',
                            `<div class="${sao.className}" style="position:absolute; right:2px; top:${top}px; color:${sao.color}; font-size:0.93em; font-weight:bold; z-index:3;">
                    ${sao.ten}
                </div>`);
                    }
                    
                });
                return { vanXuongIdx: idx_vanXuong, vanKhucIdx: idx_vanKhuc };
            }
            const gioSinhSaoIdx = anSaoTheoGioSinh(gio.split(' ')[0]);
                        /**
             * An sao Hỏa Tinh và Linh Tinh theo quy tắc Bắc phái.
             * - Dựa vào tuổi (chi năm sinh), giới tính + can năm để xác định chiều.
             * - Dựa vào chi năm sinh để xác định cung khởi, từ đó chạy đến giờ sinh.
             * - Hỏa Tinh: Dương Nam/Âm Nữ thuận chiều, Âm Nam/Dương Nữ nghịch chiều.
             * - Linh Tinh: Dương Nam/Âm Nữ nghịch chiều, Âm Nam/Dương Nữ thuận chiều.
             */

            function anSaoHoaLinhTinh(chiNam, gioitinh, canNam, gio_sinh_chi) {
                // Xác định âm dương của năm sinh
                const DUONG_CAN = ["G.", "B.", "M.", "C.", "N."];
                let isDuongNam = (DUONG_CAN.includes(canNam) && gioitinh === "Nam");
                let isAmNu = (!DUONG_CAN.includes(canNam) && gioitinh === "Nữ");
                let isAmNam = (!DUONG_CAN.includes(canNam) && gioitinh === "Nam");
                let isDuongNu = (DUONG_CAN.includes(canNam) && gioitinh === "Nữ");

                // Danh sách chi nhóm
                const nhom_DanNgoTuat = ["Dần", "Ngọ", "Tuất"];
                const nhom_ThanTyThin = ["Thân", "Tý", "Thìn"];
                const nhom_TiDauSuu = ["Tỵ", "Dậu", "Sửu"];
                const nhom_HoiMaoMui = ["Hợi", "Mão", "Mùi"];

                // 12 chi giờ
                const GIO12 = ["Tý", "Sửu", "Dần", "Mão", "Thìn", "Tỵ", "Ngọ", "Mùi", "Thân", "Dậu", "Tuất", "Hợi"];

                // === 1. Sao Hỏa Tinh ===
                // - Dương Nam/Âm Nữ thuận, Âm Nam/Dương Nữ nghịch
                let hoaTinh_cungkhoi = null, hoaTinh_dir = 1;
                if (nhom_DanNgoTuat.includes(chiNam)) { hoaTinh_cungkhoi = "Sửu"; }
                else if (nhom_ThanTyThin.includes(chiNam)) { hoaTinh_cungkhoi = "Dần"; }
                else if (nhom_TiDauSuu.includes(chiNam)) { hoaTinh_cungkhoi = "Mão"; }
                else if (nhom_HoiMaoMui.includes(chiNam)) { hoaTinh_cungkhoi = "Dậu"; }
                // Xác định chiều
                if (isDuongNam || isAmNu) hoaTinh_dir = 1; // thuận
                else hoaTinh_dir = -1; // nghịch

                // === 2. Sao Linh Tinh ===
                // - Dương Nam/Âm Nữ nghịch, Âm Nam/Dương Nữ thuận
                let linhTinh_cungkhoi = null, linhTinh_dir = 1;
                if (nhom_DanNgoTuat.includes(chiNam)) { linhTinh_cungkhoi = "Mão"; }
                else if (nhom_ThanTyThin.includes(chiNam)) { linhTinh_cungkhoi = "Tuất"; }
                else if (nhom_TiDauSuu.includes(chiNam)) { linhTinh_cungkhoi = "Tuất"; }
                else if (nhom_HoiMaoMui.includes(chiNam)) { linhTinh_cungkhoi = "Tuất"; }
                // Xác định chiều
                if (isDuongNam || isAmNu) linhTinh_dir = -1; // nghịch
                else linhTinh_dir = 1; // thuận

                // === An sao và hiện thị lên bàn lá số ===
                // Xóa nhãn cũ
                document.querySelectorAll('.laso-cell').forEach(cell => {
                    cell.querySelectorAll('.sao-hoa-tinh, .sao-linh-tinh').forEach(e => e.remove());
                });

                // Hỏa Tinh
                if (hoaTinh_cungkhoi) {
                    let startIdx = CUNG_CELLS.findIndex(c => c.chi === hoaTinh_cungkhoi);
                    let gioIdx = GIO12.indexOf(gio_sinh_chi);
                    let idx;
                    if (hoaTinh_dir === 1) idx = (startIdx + gioIdx) % 12;
                    else idx = (startIdx - gioIdx + 12 * 3) % 12;
                    let cellNum = CUNG_CELLS[idx].cell;
                    let cell = document.querySelector('.cell' + cellNum);
                    if (cell) {
                        let count = cell.querySelectorAll('.sao-hoa-tinh').length;
                        let baseTop = 130, offset = 18, top = baseTop + count * offset;
                        cell.insertAdjacentHTML('beforeend',
                            `<div class="sao-hoa-tinh" style="position:absolute; right:2px; top:${top}px; color:#e53935; font-size:0.93em; font-weight:bold; z-index:3;">
                    Hỏa Tinh
                </div>`);
                    }
                }

                // Linh Tinh
                if (linhTinh_cungkhoi) {
                    let startIdx = CUNG_CELLS.findIndex(c => c.chi === linhTinh_cungkhoi);
                    let gioIdx = GIO12.indexOf(gio_sinh_chi);
                    let idx;
                    if (linhTinh_dir === 1) idx = (startIdx + gioIdx) % 12;
                    else idx = (startIdx - gioIdx + 12 * 3) % 12;
                    let cellNum = CUNG_CELLS[idx].cell;
                    let cell = document.querySelector('.cell' + cellNum);
                    if (cell) {
                        let count = cell.querySelectorAll('.sao-linh-tinh').length;
                        let baseTop = 148, offset = 18, top = baseTop + count * offset;
                        cell.insertAdjacentHTML('beforeend',
                            `<div class="sao-linh-tinh" style="position:absolute; right:2px; top:${top}px; color:#8d6e63; font-size:0.93em; font-weight:bold; z-index:3;">
                    Linh Tinh
                </div>`);
                    }
                }
            }
            //const chiTuoi = canchi.nam.slice(2, 8).trim();
            const gio_sinh_chi = canchi.gio.split(' ')[1];
            anSaoHoaLinhTinh(chiNam, gioitinh, canNam, gio_sinh_chi);
            /**
             * An sao Tam Thai, Bát Tọa, Thiên Quý, Ân Quang theo ngày sinh.
             * @param {number} ngay_am - Ngày sinh âm lịch (1-30)
             * @param {object} saoThangSinhIdx - {taPhu: idx, huuBat: idx} (1-12)
             * @param {object} saoGioSinhIdx - {vanXuong: idx, vanKhuc: idx} (1-12)
             */
            function anSaoTheoNgaySinh(ngay_am, saoThangSinhIdx, saoGioSinhIdx) {
                // Xóa nhãn cũ nếu có
                document.querySelectorAll('.laso-cell').forEach(cell => {
                    cell.querySelectorAll('.sao-tam-thai, .sao-bat-toa, .sao-thien-quy, .sao-an-quang').forEach(e => e.remove());
                });

                // Tam Thai
                if (typeof saoThangSinhIdx.taPhu === 'number') {
                    let idx = (saoThangSinhIdx.taPhu + (ngay_am - 1)) % 12;
                    let cellNum = CUNG_CELLS[idx].cell;
                    let cell = document.querySelector('.cell' + cellNum);
                    if (cell) {
                        cell.insertAdjacentHTML('beforeend',
                            `<div class="sao-tam-thai" style="position:absolute; left:2px; top:120px; color:#4caf50; font-size:0.93em; font-weight:bold; z-index:3;">
                    Tam Thai
                </div>`);
                        console.log(cellNum);
                    }
                }

                // Bát Tọa
                if (typeof saoThangSinhIdx.huuBat === 'number') {
                    let idx = (saoThangSinhIdx.huuBat - (ngay_am - 1) + 12 * 3) % 12;
                    let cellNum = CUNG_CELLS[idx].cell;
                    let cell = document.querySelector('.cell' + cellNum);
                    if (cell) {
                        cell.insertAdjacentHTML('beforeend',
                            `<div class="sao-bat-toa" style="position:absolute; left:2px; top:96px; color:#00897b; font-size:0.93em; font-weight:bold; z-index:3;">
                    Bát Tọa
                </div>`);
                    }
                }

                // Thiên Quý
                if (typeof saoGioSinhIdx.vanKhuc === 'number') {
                    let idx = (saoGioSinhIdx.vanKhuc - (ngay_am - 2) + 12 * 3) % 12;
                    let cellNum = CUNG_CELLS[idx].cell;
                    let cell = document.querySelector('.cell' + cellNum);
                    if (cell) {
                        cell.insertAdjacentHTML('beforeend',
                            `<div class="sao-thien-quy" style="position:absolute; left:2px; top:114px; color:#d81b60; font-size:0.93em; font-weight:bold; z-index:3;">
                    Thiên Quý
                </div>`);
                    }
                }

                // Ân Quang
                if (typeof saoGioSinhIdx.vanXuong === 'number') {
                    let idx = (saoGioSinhIdx.vanXuong + (ngay_am - 2)+12*3) % 12;
                    let cellNum = CUNG_CELLS[idx].cell;
                    let cell = document.querySelector('.cell' + cellNum);
                    if (cell) {
                        cell.insertAdjacentHTML('beforeend',
                            `<div class="sao-an-quang" style="position:absolute; left:2px; top:132px; color:#5e35b1; font-size:0.93em; font-weight:bold; z-index:3;">
                    Ân Quang
                </div>`);
                    }
                }
            }
            
           
            anSaoTheoNgaySinh(
                am.ngay,
                { taPhu: thangSinhSaoIdx.taPhuIdx, huuBat: thangSinhSaoIdx.huuBatIdx },
                { vanXuong: gioSinhSaoIdx.vanXuongIdx, vanKhuc: gioSinhSaoIdx.vanKhucIdx }
            );

            // === AN SAO LỘC TỒN THEO CAN NĂM SINH ===
            /**
             * @param {string} canNam - Thiên can năm sinh ("G.", "Ấ.", "B.", "Đ.", "M.", "K.", "C.", "T.", "N.", "Q.")
             * @returns {string} - Chi của cung an sao Lộc Tồn ("Dần", ...)
             */
            function getCungLocTonByCan(canNam) {
                // Quy tắc mapping CHUẨN: mỗi can ứng với 1 cung
                // G. - Giáp: Dần
                // Ấ. - Ất: Mão
                // B. - Bính: Tỵ
                // Đ. - Đinh: Ngọ
                // M. - Mậu: Tỵ
                // K. - Kỷ: Ngọ
                // C. - Canh: Thân
                // T. - Tân: Dậu
                // N. - Nhâm: Hợi
                // Q. - Quý: Tý

                const map = {
                    "G.": "Dần",  // Giáp
                    "Ấ.": "Mão",  // Ất
                    "B.": "Tỵ",   // Bính
                    "Đ.": "Ngọ",  // Đinh
                    "M.": "Tỵ",   // Mậu
                    "K.": "Ngọ",  // Kỷ
                    "C.": "Thân", // Canh
                    "T.": "Dậu",  // Tân
                    "N.": "Hợi",  // Nhâm
                    "Q.": "Tý"    // Quý
                };
                return map[canNam] || "Dần";
            }
            // Hàm an sao Lộc Tồn lên bàn lá số
            /**
             * @param {string} canNam - thiên can năm sinh
             */
            function anSaoLocTon(canNam) {
                // Xóa nhãn cũ
                document.querySelectorAll('.laso-cell').forEach(cell => {
                    let old = cell.querySelector('.sao-locton-label');
                    if (old) old.remove();
                });
                const chiLocTon = getCungLocTonByCan(canNam);
                let found = CUNG_CELLS.find(c => c.chi === chiLocTon);
                if (found) {
                    let cell = document.querySelector('.cell' + found.cell);
                    if (cell) {
                        cell.insertAdjacentHTML('beforeend',
                            `<div class="sao-locton-label" style="position:absolute; left:2px; top:65px; color:#388e3c; font-weight:bold; font-size:0.96em; z-index:3;">
                        Lộc Tồn
                    </div>`);
                    }
                }
            }
           
            anSaoLocTon(canNam);
            document.getElementById('cungGop').innerHTML = `
                        <div><b>Người xem hạn:</b> ${hoten}</div>
                        <div><b>Năm xem hạn:</b> ${namxemhan} (${canchiNamXemHan})</div>
                        <hr/>
                        <div><b>Ngày sinh âm lịch:</b> ${am.ngay}/${am.thang}${am.nhuan ? ' (Nhuận)' : ''}/${am.nam}</div>
                        <div><b>Can chi năm:</b> ${canchi.nam}</div>
                        <div><b>Can chi tháng:</b> ${canchi.thang}</div>
                        <div><b>Can chi ngày:</b> ${canchi.ngay}</div>
                        <div><b>Can chi giờ:</b> ${canchi.gio}</div>
                        <hr/>
                        <div><b>Giới tính:</b> ${gioitinh}</div>
                        <div><b>Số tuổi âm lịch:</b> ${tuoiAm}</div>
                        <div><b>Âm dương:</b> ${amduong}</div>
                        <div><b>Mệnh:</b> ${menh}</div>
                        <div><b>Cục:</b> ${cuc}</div>
                        <div><b>Cung Mệnh:</b> ${chiMenh} </div>
                        <div><b>Cung Thân:</b> ${chiThan}</div>
                    `;

            
            highlightMenhCell(cellMenh);
            highlightThanCell(cellThan);
          

            document.getElementById('form-row').classList.add('d-none');
            document.getElementById('laso-row').classList.remove('d-none');

        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
